[//]: # (This file was autogenerated using `zio-sbt-website` plugin via `sbt generateReadme` command.)
[//]: # (So please do not edit it manually. Instead, change "docs/index.md" file or sbt setting keys)
[//]: # (e.g. "readmeDocumentation" and "readmeSupport".)

# ZIO Google Cloud Pub/Sub

[Google Cloud Pub/Sub](https://cloud.google.com/pubsub) client providing stream-based, declarative, high-level API with [zio](https://zio.dev) and [zio-streams](https://zio.dev/reference/stream) to help to concentrate on the business logic.

## Modules

- `zio-pubsub` Core components/interfaces/models
- `zio-pubsub-google` Provides publisher, admin and [StreamingPull API](https://cloud.google.com/pubsub/docs/pull#streamingpull_api) based subscriber client implementations using [Google's Java](https://cloud.google.com/java/docs/reference/google-cloud-pubsub/latest/overview) library
- `zio-pubsub-serde-circe` Provides Json Serializer/Deserializer using the [circe](https://circe.github.io/circe) codec
- `zio-pubsub-serde-vulcan` Provides Avro schema Serializer/Deserializer using the [vulcan](https://fd4s.github.io/vulcan) codec

Alternative implementations and codecs may be added later.

## Getting Started

To get started with sbt, add the following line to your build.sbt file to use the implementation with the Google Java library:

```scala
libraryDependencies += "com.anymindgroup" %% "zio-pubsub-google" % "0.2.0"
```

## Usage example

Simple ready to execute example that sets up required topic + subscription via the admin client
and runs a subscription with a publisher in the background that publishes random integer every 2 seconds. 

```scala
import com.anymindgroup.pubsub.google as G
import com.anymindgroup.pubsub.*
import zio.Console.printLine, zio.stream.*, zio.*

object PubAndSubAndAdminExample extends ZIOAppDefault:
  // topic description
  val exampleTopic: Topic[Any, Int] = Topic(
    name = "basic_example",
    schemaSetting = SchemaSettings(
      encoding = Encoding.Binary,
      schema = None,
    ),
    serde = Serde.int,
  )

  // subscription description
  val exampleSubsription: Subscription = Subscription(
    topicName = exampleTopic.name,
    name = "basic_example",
    filter = None,
    enableOrdering = false,
    expiration = None,
    deadLettersSettings = None,
  )

  // subscription process stream
  val subStream: ZStream[Subscriber, Throwable, Unit] =
    Subscriber
      .subscribe(exampleSubsription.name, Serde.int)
      .mapZIO { case (msg, ackReply) =>
        for {
          _ <- printLine(
                 s"Received message with id ${msg.meta.messageId.value}"
                   + s" and data ${msg.data}"
               )
          _ <- ackReply.ack()
        } yield ()
      }

  // publish random integer every 2 seconds
  val pubStream: ZStream[Publisher[Any, Int], Throwable, Unit] =
    ZStream
      .repeatZIOWithSchedule(Random.nextInt, Schedule.fixed(2.seconds))
      .mapZIO { sampleData =>
        for {
          id <- Publisher
                  .publish[Any, Int](
                    PublishMessage(
                      data = sampleData,
                      attributes = Map.empty,
                      orderingKey = None,
                    )
                  )
          _ <- printLine(s"Published message with id ${id.value}")
        } yield ()
      }

  // connection config (for emulator)
  val pubsubConnection: G.PubsubConnectionConfig =
    G.PubsubConnectionConfig.Emulator(
      project = G.PubsubConnectionConfig.GcpProject("any"),
      host = "localhost:8085",
    )

  // int publisher implementation
  val publisherLayer: TaskLayer[Publisher[Any, Int]] = ZLayer.scoped(
    G.Publisher.make(
      connection = pubsubConnection,
      topic = exampleTopic,
      enableOrdering = false,
    )
  )

  // subscriber implementation
  val subscriberLayer: TaskLayer[Subscriber] =
    ZLayer.scoped(G.Subscriber.makeStreamingPullSubscriber(pubsubConnection))

  // program description
  def program = for {
    // ensure example topics and subscription are setup
    _ <- G.PubsubAdmin.setup(pubsubConnection, List(exampleTopic), List(exampleSubsription))
    // run subscription while continually publishing in the background
    _ <- subStream.drainFork(pubStream).runDrain
  } yield ()

  // execute the program
  def run = program.provide(publisherLayer, subscriberLayer)
```

To run the example start Google Pub/Sub emulator with docker-compose unsing provided docker-compose.yaml

```shell
docker-compose up
```

Run example with sbt:

```shell
sbt '+examples/runMain PubAndSubAndAdminExample'
```

## Documentation

Learn more on the [ZIO Google Cloud Pub/Sub homepage](https://github.com/AnyMindGroup/zio-pubsub)!

## Contributing

If you have any question or problem feel free to open an issue or discussion.

People are expected to follow the [Code of Conduct](CODE_OF_CONDUCT.md) when discussing on the GitHub issues or PRs.

## Code of Conduct

See the [Code of Conduct](CODE_OF_CONDUCT.md)

## Support

Open an issue or discussion on [GitHub](https://github.com/AnyMindGroup/zio-pubsub/issues)

## Credits

Inspired by libraries like [zio-kafka](https://github.com/zio/zio-kafka) 
and [fs2-pubsub](https://github.com/permutive-engineering/fs2-pubsub) to provide a similar experience.

## License

[License](LICENSE)
